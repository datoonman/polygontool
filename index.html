<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Polygon Validator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üó∫Ô∏è Polygon Validator</h1>
            <p class="subtitle">Validate and visualize polygon geometries</p>
        </div>

        <div class="controls">
            <div class="toggle-group">
                <span class="toggle-label">Coordinate Mode:</span>
                <span class="mode-label">
                    Origin (Lat, Long)
                    <span class="tooltip">Coordinates are [Latitude, Longitude]</span>
                </span>
                <div class="toggle-switch" id="coordToggle"></div>
                <span class="mode-label">
                    Orbit (Long, Lat)
                    <span class="tooltip">Coordinates are [Longitude, Latitude]</span>
                </span>
                <span class="mode-indicator" id="modeIndicator">Origin Mode</span>
            </div>

            <div class="mode-selector">
                <button class="mode-btn active" data-mode="single">Single Polygon</button>
                <button class="mode-btn bulk-mode" data-mode="bulk">Bulk Upload</button>
            </div>
        </div>

        <div class="content">
            <div class="view active" id="singleView">
                <div class="single-layout">
                    <div>
                        <h3 style="margin-bottom: 12px; color: #1e293b;">Visualization</h3>
                        <div class="map-container" id="mapContainer">
                            <canvas class="map-canvas" id="singleCanvas"></canvas>
                            <div class="coord-bubble" id="coordBubble"></div>
                        </div>
                        <div id="singleResults"></div>
                    </div>
                    
                    <div>
                        <h3 style="margin-bottom: 12px; color: #1e293b;">Paste Polygon JSON</h3>
                        <div class="json-input-container">
                            <textarea class="json-input" id="jsonInput" placeholder='{"type":"Polygon","coordinates":[[[6.233,0.700],...]]]}'></textarea>
                        </div>
                        <div class="format-hint" id="formatHint">
                            <strong>Expected format:</strong> <span id="formatHintText">[Latitude, Longitude]</span>
                        </div>
                        
                        <div class="button-group">
                            <button class="btn-primary" onclick="validateSingle()">Validate Polygon</button>
                            
                            <div class="tools-container">
                                <button class="btn-secondary" onclick="toggleToolsDropdown()">Tools ‚ñº</button>
                                <div class="tools-dropdown" id="toolsDropdown">
                                    <div class="tool-item" onclick="autoClosePolygon()">
                                        Auto-Close Polygon
                                    </div>
                                    <div class="tool-item" id="convertToolItem" onclick="convertToRightHandRule()">
                                        Convert to Right Hand Rule
                                    </div>
                                    <div class="tool-item" id="removeDuplicatesToolItem" onclick="removeDuplicateNodes()">
                                        Remove Duplicate Nodes
                                    </div>
                                </div>
                            </div>
                            
                            <button class="btn-secondary" onclick="clearSingle()">Clear</button>
                        </div>
                        
                        <div id="jsonDisplay" class="hidden">
                            <div class="json-display-title">Polygon Summary:</div>
                            <div class="json-display" id="jsonDisplayContent"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="view" id="bulkView">
                <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">
                    <div class="upload-icon">üìÅ</div>
                    <h3>Drop your file here or click to browse</h3>
                    <p style="color: #64748b; margin-top: 8px;">Supports CSV, XLSX, XLS</p>
                    <p style="color: #64748b; margin-top: 4px; font-size: 0.9em;">Required columns: <code>ID</code> and <code>Polygon</code></p>
                    <input type="file" id="fileInput" class="file-input" accept=".csv,.xlsx,.xls" onchange="handleFile(event)">
                </div>

                <!-- Column Mapping Section -->
                <div id="columnMapping" class="hidden column-mapping-section">
                    <div class="mapping-header">
                        <h3>üìã Column Mapping</h3>
                        <button class="btn-secondary small" onclick="resetUpload()">Upload Different File</button>
                    </div>
                    <div class="mapping-controls">
                        <div class="mapping-field">
                            <label>ID Column:</label>
                            <select id="idColumnSelect" onchange="updateColumnMapping()"></select>
                        </div>
                        <div class="mapping-field">
                            <label>Polygon Column:</label>
                            <select id="polygonColumnSelect" onchange="updateColumnMapping()"></select>
                        </div>
                        <div class="mapping-status" id="mappingStatus"></div>
                    </div>
                </div>

                <!-- Control Bar -->
                <div id="bulkControls" class="hidden bulk-control-bar">
                    <div class="control-left">
                        <label class="checkbox-label">
                            <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()">
                            <span>Select All on Page (<span id="selectedCount">0</span> selected)</span>
                        </label>
                    </div>
                    <div class="control-right">
                        <button class="btn-action" id="fixSelectedBtn" onclick="fixSelected()" disabled>
                            üîß Fix Selected
                        </button>
                        <div class="export-dropdown-container">
                            <button class="btn-primary" onclick="toggleExportDropdown()">
                                Export ‚ñº
                            </button>
                            <div class="export-dropdown" id="exportDropdown">
                                <div class="export-item" onclick="exportData('xlsx')">Export as XLSX</div>
                                <div class="export-item" onclick="exportData('csv')">Export as CSV</div>
                            </div>
                        </div>
                        <button class="btn-secondary" onclick="revertToOriginal()">
                            ‚Ü∫ Revert to Original
                        </button>
                    </div>
                </div>

                <div id="bulkResults"></div>

                <!-- Pagination Controls -->
                <div id="paginationControls" class="hidden pagination-bar">
                    <div class="pagination-info">
                        <span>Showing <span id="showingRange">1-50</span> of <span id="totalRows">0</span> rows</span>
                        <select id="pageSizeSelect" onchange="changePageSize()">
                            <option value="50">50 per page</option>
                            <option value="100">100 per page</option>
                            <option value="200">200 per page</option>
                        </select>
                    </div>
                    <div class="pagination-buttons">
                        <button class="page-btn" id="firstPageBtn" onclick="goToPage(1)">First</button>
                        <button class="page-btn" id="prevPageBtn" onclick="goToPage(currentPage - 1)">Previous</button>
                        <span class="page-indicator">Page <span id="currentPageNum">1</span> of <span id="totalPages">1</span></span>
                        <button class="page-btn" id="nextPageBtn" onclick="goToPage(currentPage + 1)">Next</button>
                        <button class="page-btn" id="lastPageBtn" onclick="goToPage(totalPages)">Last</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <button class="help-btn" onclick="openHelp()">?</button>

    <!-- Processing Report Modal -->
    <div class="modal" id="reportModal">
        <div class="modal-content report-modal">
            <div class="modal-header">
                <h2>üìä Processing Report</h2>
                <button class="close-btn" onclick="closeModal('reportModal')">√ó</button>
            </div>
            <div style="padding: 30px;">
                <div class="report-summary" id="reportSummary"></div>
                <div id="reportErrors" class="hidden">
                    <h3 style="color: #1e293b; margin-bottom: 12px;">‚ö†Ô∏è Errors</h3>
                    <div class="report-errors" id="reportErrorsList"></div>
                    <button class="btn-secondary" onclick="exportErrors()" style="margin-top: 12px;">
                        Export Error Rows as XLSX
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="vizModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Polygon Visualization</h2>
                <button class="close-btn" onclick="closeModal('vizModal')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="modal-map">
                    <canvas class="map-canvas" id="modalCanvas"></canvas>
                </div>
                <div class="modal-sidebar">
                    <div class="section-title">Nodes (<span id="nodeCount">0</span>)</div>
                    <ul class="node-list" id="nodeList"></ul>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="helpModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìö User Guide</h2>
                <button class="close-btn" onclick="closeModal('helpModal')">√ó</button>
            </div>
            <div class="help-content">
                <h3>üéØ Overview</h3>
                <p>This tool validates polygon geometries and checks for common issues like self-intersection, duplicate nodes, and winding direction.</p>

                <h3>üîÑ Coordinate Modes Explained</h3>
                <p><strong>IMPORTANT:</strong> The coordinate mode tells the tool how to interpret the order of numbers in your JSON coordinates.</p>
                
                <p><strong>Origin Mode (Lat, Long)</strong>: Your JSON has coordinates in <code>[Latitude, Longitude]</code> order</p>
                <div class="example">
                    Example: <code>[0.700, 6.233]</code> means the FIRST number is Latitude, SECOND is Longitude
                </div>
                
                <p><strong>Orbit Mode (Long, Lat)</strong>: Your JSON has coordinates in <code>[Longitude, Latitude]</code> order</p>
                <div class="example">
                    Example: <code>[6.233, 0.700]</code> means the FIRST number is Longitude, SECOND is Latitude
                </div>

                <h3>üõ†Ô∏è Tools Menu</h3>
                <p>The Tools button provides access to polygon manipulation features:</p>
                <ul>
                    <li><strong>Auto-Close Polygon:</strong> Automatically adds the first coordinate to the end if polygon isn't closed</li>
                    <li><strong>Convert to Right Hand Rule:</strong> Reverses vertex order to follow Right Hand Rule while keeping the first node as the starting point. Works on both closed and unclosed polygons. (disabled if already RHR)</li>
                    <li><strong>Remove Duplicate Nodes:</strong> Removes all duplicate coordinates except the closing pair (disabled if none found)</li>
                </ul>

                <h3>üìê Polygon Format</h3>
                <p>Polygons must follow GeoJSON format:</p>
                <div class="example">
                    <code>{"type":"Polygon","coordinates":[[[lon1,lat1],[lon2,lat2],...,[lon1,lat1]]]}</code>
                </div>
                <p><strong>Critical:</strong> The first and last coordinates must be identical to close the polygon.</p>

                <h3>‚úÖ Validation States</h3>
                <ul>
                    <li><strong>Valid:</strong> Polygon has no structural issues</li>
                    <li><strong>Self-Intersecting:</strong> Polygon edges cross each other</li>
                    <li><strong>Duplicate Nodes:</strong> Same coordinates appear multiple times (excluding the closing node pair)</li>
                    <li><strong>Blank:</strong> Empty or missing polygon data</li>
                    <li><strong>Point:</strong> Single coordinate instead of polygon</li>
                    <li><strong>Invalid JSON:</strong> Malformed JSON structure</li>
                </ul>

                <h3>üß≠ Hand Rules (Rules Type)</h3>
                <p><strong>Right Hand Rule:</strong> Vertices are ordered counter-clockwise when viewed from above.</p>
                <p><strong>Left Hand Rule:</strong> Vertices are ordered clockwise when viewed from above.</p>
                <p>The tool identifies which rule your polygon follows - there's no "pass/fail", just identification.</p>

                <h3>üîß Version History & Patch Notes</h3>
                
                <div class="version-section">
                    <div class="version-header" onclick="toggleVersion('v31')">
                        <span class="version-badge">v31</span>
                        <span>Latest - Improved Right Hand Rule Conversion</span>
                        <span id="v31-arrow">‚ñº</span>
                    </div>
                    <div class="version-content" id="v31-content">
                        <div class="version-item">‚Ä¢ Fixed: Right Hand Rule conversion now properly handles unclosed polygons</div>
                        <div class="version-item">‚Ä¢ Fixed: First node now remains as starting point during conversion (both closed & unclosed)</div>
                        <div class="version-item">‚Ä¢ Improved: Unclosed polygons are converted without auto-closing, preserving "Auto-Close" utility</div>
                    </div>
                </div>

                <div class="version-section">
                    <div class="version-header" onclick="toggleVersion('v30')">
                        <span class="version-badge">v30</span>
                        <span>Tools Menu & Polygon Manipulation</span>
                        <span id="v30-arrow">‚ñº</span>
                    </div>
                    <div class="version-content collapsed" id="v30-content">
                        <div class="version-item">‚Ä¢ Added Tools dropdown menu with polygon manipulation features</div>
                        <div class="version-item">‚Ä¢ New: Convert to Right Hand Rule (reverses vertex order)</div>
                        <div class="version-item">‚Ä¢ New: Remove Duplicate Nodes (keeps first occurrence)</div>
                        <div class="version-item">‚Ä¢ Tool items are greyed out when not applicable</div>
                        <div class="version-item">‚Ä¢ Auto-Close moved to Tools menu</div>
                        <div class="version-item">‚Ä¢ All tools auto-validate after execution</div>
                    </div>
                </div>

                <div class="version-section">
                    <div class="version-header" onclick="toggleVersion('v29')">
                        <span class="version-badge">v29</span>
                        <span>Map Pan & Smooth Zoom</span>
                        <span id="v29-arrow">‚ñº</span>
                    </div>
                    <div class="version-content collapsed" id="v29-content">
                        <div class="version-item">‚Ä¢ Added smooth zoom functionality (mouse wheel)</div>
                        <div class="version-item">‚Ä¢ Added map panning - drag to reposition view</div>
                        <div class="version-item">‚Ä¢ Auto-hide node labels for large polygons (100+ nodes)</div>
                        <div class="version-item">‚Ä¢ Improved polygon summary spacing</div>
                    </div>
                </div>

                <button class="show-more-btn" id="showMoreBtn" onclick="toggleOlderVersions()">Show Earlier Versions</button>

                <div id="olderVersions" style="display: none;">
                    <div class="version-section">
                        <div class="version-header" onclick="toggleVersion('v28')">
                            <span class="version-badge">v28</span>
                            <span>Draggable Bubbles & Auto-Close</span>
                            <span id="v28-arrow">‚ñº</span>
                        </div>
                        <div class="version-content collapsed" id="v28-content">
                            <div class="version-item">‚Ä¢ Added draggable coordinate bubbles when locked</div>
                            <div class="version-item">‚Ä¢ Added "Auto-Close" button</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
</body>
</html>
